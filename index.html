
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Art.sy Engineering</title>
  <meta name="author" content="Art.sy">

  
  <meta name="description" content="There is a great deal of misinformation on the web about detecting an
iPad or an iPhone in JavaScript. The
top answer on stackoverflow -
and many &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://artsy.github.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Art.sy Engineering" type="application/atom+xml">
  <!--[if IE 8]>
<link href="/stylesheets/custom/ie_font.css" type="text/css">
<![endif]-->
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-12450662-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>


<body>
  
  <a href="/">
    <h1 id="lrg-mark">
      <span>Art.sy</span>
    </h1>
  </a>
  
  <header id="banner"><hgroup>
  <div id="header">
    <h2>Inspiration from the engineering team at <a href="http://art.sy">Art.sy</a> — A new way to discover fine art.</h2>
  </div>
</hgroup>

</header>
  
  <div id="main">
    <div id="mobile_search">
      <form action="http://google.com/search" method="get">
        <input type="hidden" name="q" value="site:artsy.github.com" />
        <input class="search" type="text" name="q" results="0" placeholder="Search" />
      </form>
    </div>
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
    <a href="/blog/2012/10/18/the-perils-of-ios-user-agent-sniffing/">
      <div class="date">




  
<time datetime="2012-10-18T15:19:00-04:00" pubdate>10/18/12</time></div>
    
    
      <h1 class="entry-title">The Perils of iOS User Agent Strings</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p>There is a great deal of misinformation on the web about detecting an
iPad or an iPhone in JavaScript. The
<a href="http://stackoverflow.com/a/4617648">top answer on stackoverflow</a> -
and many blog posts using this technique - are all incorrect.</p>

<p>The conventional wisdom is that iOS devices have a user agent for
Safari and a user agent for the UIWebView. This assumption is
incorrect as iOS apps can and do
<a href="http://stackoverflow.com/a/8666438">customize their user agent</a>. The
main offender here is Facebook, whose iOS app alone accounts for about
1-3% of Art.sy&#8217;s daily traffic.</p>

<p>Compare these user agent strings from iOS devices:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># iOS Safari
</span><span class='line'>iPad: Mozilla/5.0 (iPad; CPU OS 5_1 like Mac OS X) AppleWebKit/534.46 (KHTML, like Gecko) Version/5.1 Mobile/9B176 Safari/7534.48.3
</span><span class='line'>iPhone: Mozilla/5.0 (iPhone; CPU iPhone OS 5_0 like Mac OS X) AppleWebKit/534.46 (KHTML, like Gecko) Version/5.1 Mobile/9A334 Safari/7534.48.3
</span><span class='line'>
</span><span class='line'># UIWebView
</span><span class='line'>iPad: Mozilla/5.0 (iPad; CPU OS 5_1 like Mac OS X) AppleWebKit/534.46 (KHTML, like Gecko) Mobile/98176
</span><span class='line'>iPhone: Mozilla/5.0 (iPhone; U; CPU iPhone OS 4_1 like Mac OS X; en-us) AppleWebKit/532.9 (KHTML, like Gecko) Mobile/8B117
</span><span class='line'>
</span><span class='line'># Facebook UIWebView
</span><span class='line'>iPad: Mozilla/5.0 (iPad; U; CPU iPhone OS 5_1_1 like Mac OS X; en_US) AppleWebKit (KHTML, like Gecko) Mobile [FBAN/FBForIPhone;FBAV/4.1.1;FBBV/4110.0;FBDV/iPad2,1;FBMD/iPad;FBSN/iPhone OS;FBSV/5.1.1;FBSS/1; FBCR/;FBID/tablet;FBLC/en_US;FBSF/1.0]
</span><span class='line'>iPhone: Mozilla/5.0 (iPhone; U; CPU iPhone OS 5_1_1 like Mac OS X; ru_RU) AppleWebKit (KHTML, like Gecko) Mobile [FBAN/FBForIPhone;FBAV/4.1;FBBV/4100.0;FBDV/iPhone3,1;FBMD/iPhone;FBSN/iPhone OS;FBSV/5.1.1;FBSS/2; tablet;FBLC/en_US]</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>The old way to identify iPhone / iPad in JavaScript</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">IS_IPAD</span> <span class="o">=</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/iPad/i</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'><span class="nx">IS_IPHONE</span> <span class="o">=</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/iPhone/i</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/iPod/i</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you were to go with this approach for detecting iPhone and iPad,
you would end up with IS_IPHONE <em>and</em> IS_IPAD both being true if a user
comes from Facebook on an iPad. That could create some odd behavior!</p>

<p>Given that I have no other examples of people customizing user agents
to such a gross degree, here is the correct way to identify iPhone / iPad in
JavaScript.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">IS_IPAD</span> <span class="o">=</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/iPad/i</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'><span class="nx">IS_IPHONE</span> <span class="o">=</span> <span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/iPhone/i</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/iPod/i</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">IS_IPAD</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">IS_IPHONE</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We simply declare <code>IS_IPHONE</code> to be <code>false</code> on iPads to cover for the
bizarre Facebook UIWebView iPad user agent. This is one example of how
<em>user agent sniffing is unreliable</em>. If there is any way you can avoid
this behavior (hint: CSS Media Queries), DO IT.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2012/10/18/so-you-want-to-do-a-css3-3d-transform/">
      <div class="date">




  
<time datetime="2012-10-18T00:00:00-04:00" pubdate>10/18/12</time></div>
    
    
      <h1 class="entry-title">So You Want to Do a CSS3 3D Transform?</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post details the first of many challenges we faced in 3D
transforming the <a href="http://art.sy">homepage of Art.sy</a> (inspired by
<a href="https://github.com/hakimel/meny">Meny</a>): Detecting CSS 3D transform
support.</p>

<p>Front-end development is messy in today&#8217;s fragmented world. At Art.sy,
our goal is to do what it takes to provide an incredible experience
for <em>all</em> of our users (IE8+, iOS and the usual suspects). Deploying
bleeding edge tech, like CSS 3D transforms, is an exercise in
compromising principals for practicality &#8211; and managing these
&#8220;compromises&#8221; in well documented code.</p>

<p>We looked to Modernizr&#8217;s feature detection approach to provide us with
a reliable way to detect CSS3 3D transform support across browsers. They have some
<a href="https://github.com/Modernizr/Modernizr/issues/590">well</a>
<a href="https://github.com/Modernizr/Modernizr/issues/465">documented</a>
<a href="https://github.com/Modernizr/Modernizr/issues/240">struggles</a> around
the issue. After flipping most of the tables in the office ┻━┻ ︵ヽ
(`Д´)ﾉ︵﻿ ┻━┻ , we settled on useragent sniffing as the most robust
method for detecting CSS3 3D transform support. But why did none
of the available methods work for us?</p>

<p>CSS3 3D transforms involve interaction between the browser and the
graphics card. The browser may be able to parse the 3D declarations
but may not be able to properly instruct the graphics card in how to
render your page. There are many possible outcomes ranging from the
page rendering with lines across it (Safari 4) to the page rendering
beautifully then crashing the browser seconds later (Safari on
iOS4). Any &#8216;feature detection&#8217; approach would unacceptably flag these
as &#8216;supports CSS3 3D transforms&#8217;. This is one case where &#8216;feature
detection&#8217; fails and user agent sniffing (and lots of testing) wins
hands down.</p>

<p>Most feature detection assumes a &#8220;supports&#8221; or &#8220;does not support&#8221;
binary. This is not the case with CSS3 3D transforms &#8211; there is a
&#8220;gradient of support&#8221;. Additionally, enabling 3D transforms causes the
page to be re-rendered in an entirely different rendering engine which
then causes other problems (more on this in a later post).</p>

<p>CSS3 3D transform support can be separated into 4 levels:</p>

<ol>
<li>Reliably supports 3D transforms across most machines. For example:
Safari 6.</li>
<li>Can parse and apply 3D transform declarations but ignores the 3D
parts. For example: Chrome on a Retina MacBook Pro.</li>
<li>Can parse and apply 3D transform declarations but renders in
unacceptable ways. For example: Safari 4 and Safari 4/5 on Windows
show lines across the page.</li>
<li>Cannot apply 3D transform declarations in any way. For example:
IE or Firefox &lt; v10.</li>
</ol>


<p>Here are a few popular ways of detecting CSS3 3D transform support and why
they don&#8217;t work for us:</p>

<p><em>Meny / Hakim&#8217;s method</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="c1"># apply these styles to the body in css then see if they are applied in JS</span>
</span><span class='line'><span class="nv">docStyle = </span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">style</span>
</span><span class='line'><span class="nv">supports3DTransforms = </span> <span class="s1">&#39;WebkitPerspective&#39;</span> <span class="k">in</span> <span class="nx">docStyle</span> <span class="o">or</span>
</span><span class='line'>                        <span class="s1">&#39;MozPerspective&#39;</span> <span class="k">in</span> <span class="nx">docStyle</span> <span class="o">or</span>
</span><span class='line'>                        <span class="s1">&#39;msPerspective&#39;</span> <span class="k">in</span> <span class="nx">docStyle</span> <span class="o">or</span>
</span><span class='line'>                        <span class="s1">&#39;OPerspective&#39;</span> <span class="k">in</span> <span class="nx">docStyle</span> <span class="o">or</span>
</span><span class='line'>                        <span class="s1">&#39;perspective&#39;</span> <span class="k">in</span> <span class="nx">docStyle</span>
</span></code></pre></td></tr></table></div></figure>


<p>This works best and is straightforward code. The only
issue is that it throws a positive for iOS4 causing the browser to
crash and a positive for Safari on Windows and Safari 4 OSX which both
display a grid over the page when using the 3D renderer.</p>

<p><em>iScroll4 method</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">has3D = </span><span class="o">-&gt;</span> <span class="s1">&#39;WebKitCSSMatrix&#39;</span> <span class="k">in</span> <span class="nb">window</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;m11&#39;</span> <span class="k">in</span> <span class="k">new</span> <span class="nx">WebKitCSSMatrix</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>This only works reliably Safari in our testing.</p>

<p><em>Modernizer method</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">ret = </span><span class="o">!!</span><span class="nx">testPropsAll</span><span class="p">(</span><span class="s1">&#39;perspective&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span> <span class="nx">ret</span> <span class="o">and</span> <span class="s1">&#39;webkitPerspective&#39;</span> <span class="k">in</span> <span class="nx">docElement</span><span class="p">.</span><span class="nx">style</span> <span class="p">)</span>
</span><span class='line'>  <span class="c1"># create a dib and see if it moves</span>
</span><span class='line'>  <span class="nx">injectElementWithStyles</span><span class="p">(</span><span class="s1">&#39;@media (transform-3D), (-webkit-transform-3D){#modernizr{left:9px;position:absolute;height:3px;}}&#39;</span><span class="p">,</span> <span class="nf">(node, rule) -&gt;</span>
</span><span class='line'>    <span class="nv">ret = </span><span class="nx">node</span><span class="p">.</span><span class="nx">offsetLeft</span> <span class="o">===</span> <span class="mi">9</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">===</span> <span class="mi">3</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This creates a div, transforms it, and then checks if it&#8217;s position
has changed as expected. It only works in reliably in Safari.
It <a href="https://github.com/Modernizr/Modernizr/issues/590">sometimes works in Chrome</a>
but throws a false positive in the case of Chrome on Retina MacBook
Pro as the element does move &#8211; just not in 3D space.</p>

<p><em>User Agent method</em></p>

<p>We want to maintain wide support of new tech while ensuring all users
have a great experience. Modernizr and the feature detection group
have their heart in the right place and do a great job most of the
time. That said, user agent sniffing is the only way to handle the
complex support scenarios inherent in bleeding edge CSS3 tech such as
3D transforms.</p>

<p>Here is our method/hack for identifying browsers that support CSS3 3D
transforms well:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="p">(</span><span class="o">-&gt;</span>
</span><span class='line'>  <span class="nv">docElement = </span><span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span>
</span><span class='line'>  <span class="nv">uagent = </span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">browsers = </span><span class="p">[</span>
</span><span class='line'>    <span class="p">[</span><span class="s1">&#39;webkit&#39;</span><span class="p">,</span>  <span class="mi">530</span><span class="p">]</span>        <span class="c1"># not well supported in Safari 4, Safari 5 webkit version is 530.17</span>
</span><span class='line'>    <span class="p">[</span><span class="s1">&#39;chrome&#39;</span><span class="p">,</span>  <span class="mi">12</span><span class="p">]</span>
</span><span class='line'>    <span class="p">[</span><span class="s1">&#39;mozilla&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
</span><span class='line'>    <span class="p">[</span><span class="s1">&#39;opera&#39;</span><span class="p">,</span>   <span class="kc">Infinity</span><span class="p">]</span>   <span class="c1"># not supported</span>
</span><span class='line'>    <span class="p">[</span><span class="s1">&#39;msie&#39;</span><span class="p">,</span>    <span class="kc">Infinity</span><span class="p">]</span> <span class="p">]</span> <span class="c1"># not supported</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># From: http://api.jquery.com/jQuery.browser</span>
</span><span class='line'>  <span class="nv">uaMatch = </span><span class="nf">(ua) -&gt;</span>
</span><span class='line'>    <span class="nv">match =</span>
</span><span class='line'>      <span class="sr">/(chrome)[ \/]([\w.]+)/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">ua</span><span class="p">)</span> <span class="o">or</span>
</span><span class='line'>      <span class="sr">/(webkit)[ \/]([\w.]+)/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">ua</span><span class="p">)</span> <span class="o">or</span>
</span><span class='line'>      <span class="sr">/(opera)(?:.*version|)[ \/]([\w.]+)/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">ua</span><span class="p">)</span> <span class="o">or</span>
</span><span class='line'>      <span class="sr">/(msie) ([\w.]+)/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">ua</span><span class="p">)</span> <span class="o">or</span>
</span><span class='line'>      <span class="nx">ua</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;compatible&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="sr">/(mozilla)(?:.*? rv:([\w.]+)|)/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span> <span class="nx">ua</span> <span class="p">)</span> <span class="o">or</span>
</span><span class='line'>      <span class="p">[]</span>
</span><span class='line'>    <span class="p">{</span> <span class="nv">browser: </span><span class="p">(</span><span class="nx">match</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">or</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="nv">version: </span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">or</span> <span class="mi">0</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">addNo3DTransform = </span><span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">docElement.className = </span><span class="nx">docElement</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">replace</span> <span class="s1">&#39;csstransforms3D&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>    <span class="nx">docElement</span><span class="p">.</span><span class="nx">className</span> <span class="o">+=</span> <span class="s1">&#39; no-csstransforms3D&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">add3DTransform = </span><span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">docElement.className = </span><span class="nx">docElement</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">replace</span> <span class="s1">&#39;no-csstransforms3D&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>    <span class="nx">docElement</span><span class="p">.</span><span class="nx">className</span> <span class="o">+=</span> <span class="s1">&#39; csstransforms3D&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># default to no CSS3 3D transform support</span>
</span><span class='line'>  <span class="nx">addNo3DTransform</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">match = </span><span class="nx">uaMatch</span> <span class="nx">uagent</span>
</span><span class='line'>  <span class="k">for</span> <span class="nx">browser</span> <span class="k">in</span> <span class="nx">browsers</span>
</span><span class='line'>    <span class="k">if</span> <span class="nx">browser</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nx">match</span><span class="p">.</span><span class="nx">browser</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">match</span><span class="p">.</span><span class="nx">version</span> <span class="o">&gt;=</span> <span class="nx">browser</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>        <span class="nx">add3DTransform</span><span class="p">()</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="nx">addNo3DTransform</span><span class="p">()</span>
</span><span class='line'>      <span class="k">break</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">IS_IPHONE = </span><span class="nx">uagent</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s1">&#39;iphone&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">or</span> <span class="nx">uagent</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s1">&#39;ipod&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
</span><span class='line'>  <span class="nv">IS_IPAD = </span><span class="nx">uagent</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s1">&#39;ipad&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
</span><span class='line'>  <span class="nv">IS_IOS = </span><span class="nx">IS_IPHONE</span> <span class="o">or</span> <span class="nx">IS_IPAD</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># iOS 6 is our support cut off for iPad</span>
</span><span class='line'>  <span class="nv">match = </span><span class="sr">/\os ([0-9]+)/</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">uagent</span>
</span><span class='line'>  <span class="nv">IS_LT_IOS6 = </span><span class="nx">match</span> <span class="o">and</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">and</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">6</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># 3D transforms are supported but do not work well on iPhone</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">IS_IPHONE</span>
</span><span class='line'>    <span class="nx">addNo3DTransform</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># disable 3D transform for older versions of Safari on iPad</span>
</span><span class='line'>  <span class="k">else</span> <span class="k">if</span> <span class="nx">IS_IPAD</span> <span class="o">and</span> <span class="nx">IS_LT_IOS6</span>
</span><span class='line'>    <span class="nx">addNo3DTransform</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># deactivate 3D transform for Safari on Windows</span>
</span><span class='line'>  <span class="k">else</span> <span class="k">if</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s1">&#39;Safari&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">and</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s1">&#39;Windows&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
</span><span class='line'>    <span class="nx">addNo3DTransform</span><span class="p">()</span>
</span><span class='line'><span class="p">)()</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you would like to take issue with or improve this code please check
it out <a href="https://github.com/zamiang/detect-css3-3D-transform">on Github</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2012/10/10/artsy-technology-stack/">
      <div class="date">




  
<time datetime="2012-10-10T21:21:00-04:00" pubdate>10/10/12</time></div>
    
    
      <h1 class="entry-title">Art.sy&#8217;s Technology Stack</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p>The public launch of Art.sy via the <a href="http://www.nytimes.com/2012/10/09/arts/design/artsy-is-mapping-the-world-of-art-on-the-web.html">New York Times</a> is a good opportunity to describe our current technology stack.</p>

<p>What you see when you go to <a href="http://art.sy">art.sy</a> is a website built with <a href="http://backbonejs.org/">Backbone.js</a> and written in <a href="http://coffeescript.org/">CoffeeScript</a>. It renders JSON data from <a href="http://rubyonrails.org/">Ruby on Rails</a>, <a href="https://github.com/intridea/grape">Ruby Grape</a> and <a href="http://nodejs.org/">Node.js</a> services. Text search is powered by <a href="http://lucene.apache.org/solr/">Apache Solr</a>. We also have an <a href="https://developer.apple.com/devcenter/ios/index.action">iOS</a> application that talks to the same back-end Ruby API. We run all our web processes on <a href="http://www.heroku.com/">Heroku</a> and all job queues on <a href="http://aws.amazon.com/">Amazon EC2</a>. Our data store is <a href="http://www.mongodb.org/">MongoDB</a>, operated by <a href="https://mongohq.com/">MongoHQ</a> and we have some <a href="http://redis.io/">Redis</a> instances. Our assets, including images, are served from <a href="http://aws.amazon.com/s3/">Amazon S3</a> via the <a href="http://aws.amazon.com/cloudfront/">CloudFront CDN</a>. We heavily rely on <a href="http://memcached.org/">Memcached</a> Heroku addon and we use <a href="http://sendgrid.com/">SendGrid</a> and <a href="http://mailchimp.com/">MailChimp</a> to send e-mail. Systems are monitored by a combination of <a href="http://newrelic.com/">New Relic</a> and <a href="https://www.pingdom.com/">Pingdom</a>. All of this is built, tested and deployed with <a href="http://jenkins-ci.org/">Jenkins</a>.</p>

<p><img src="/images/2012-10-10-artsy-technology-stack/artsy-infrastructure.png"></p>

<p>In this post I&#8217;ll go in depth in our current system architecture and tell you the story about how these parts all came together.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2012/10/10/artsy-technology-stack/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2012/10/09/how-to-run-rspec-test-suites-in-parallel-with-jenkins-ci-build-flow/">
      <div class="date">




  
<time datetime="2012-10-09T21:21:00-04:00" pubdate>10/09/12</time></div>
    
    
      <h1 class="entry-title">How to Run RSpec Test Suites in Parallel With JenkinsCI Build Flow</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p>We now have over 4700 RSpec examples in one of our projects. They are stable, using the techniques described in an <a href="/blog/2012/02/03/reliably-testing-asynchronous-ui-w-slash-rspec-and-capybara/">earlier post</a> and organized in <a href="/blog/2012/05/15/how-to-organize-over-3000-rspec-specs-and-retry-test-failures/">suites</a>. But they now take almost 3 hours to run, which is clearly unacceptable.</p>

<p>To solve this, we have parallelized parts of the process with existing tools, and can turn a build around in just under an hour. This post will dive into our <a href="http://jenkins-ci.org/">Jenkins</a> build flow setup.</p>

<p>To keep things simple, we&#8217;re going to only build the <code>master</code> branch. When a change is committed on <code>master</code> we&#8217;re going to push <code>master</code> to a <code>master-ci</code> branch and trigger a distributed build on <code>master-ci</code>. Once all the parts have finished, we&#8217;ll complete the build by pushing <code>master-ci</code> to <code>master-succeeded</code> and notify the dev team of success or failure.</p>

<p>Here&#8217;s a diagram of what&#8217;s going on.</p>

<p><img src="/images/2012-10-09-how-to-run-rspec-test-suites-in-parallel-with-jenkins-ci-build-flow/master-ci.png"></p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2012/10/09/how-to-run-rspec-test-suites-in-parallel-with-jenkins-ci-build-flow/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2012/09/13/on-grid-thumbnails/">
      <div class="date">




  
<time datetime="2012-09-13T16:40:00-04:00" pubdate>09/13/12</time></div>
    
    
      <h1 class="entry-title">On Grid Thumbnails</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/images/2012-09-13-on-grid-thumbnails/grid.jpg"></p>

<p>Artsy Folio, our free iPad app for Gallery Partners, had been in the App Store for a couple of weeks before the iPad with a Retina display was announced. This had been something we expected internally and felt the application would be ready. We had all our image assets available in <em>@2x</em> versions and an image pipeline that would take scaling into account. With that in mind, we changed our artwork grid view to show a double resolution image. Finally, once we were happy that it worked fine on the simulator, we sent the build off to Apple for review.</p>

<p>The app passed review, and was Retina-ready before the actual release. But within hours of getting our hands on a real Retina iPad, we had to pull the app. This post will explain why, and what we did to work it out.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2012/09/13/on-grid-thumbnails/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2012/09/12/how-artsy-builds-experiments-labs-and-easter-eggs/">
      <div class="date">




  
<time datetime="2012-09-12T21:21:00-04:00" pubdate>09/12/12</time></div>
    
    
      <h1 class="entry-title">How Art.sy Builds Labs, Experiments and Easter Eggs</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p>At Art.sy Engineering we encourage a culture of experimentation with something called <em>labs</em>.</p>

<p>A new feature released into production is usually only turned on for a handful of users. We get feedback from our own team and a tiny group of early adopters, iterate, fix bugs, toss failed experiments and work on promoting complete, well behaved features to all users. The labs infrastructure gives us a chance to sleep on an idea and polish details. It also allows us to make progress continuously and flip a switch on the very last day.</p>

<p>My favorite labs features push our collective imagination and give birth to productive brainstorms around coffee at a popular startup hangout around the corner from our Manhattan office. But the team&#8217;s favorite labs are, by far, those that ship as easter eggs. These are fun and sometimes useful features that don&#8217;t make much business sense. So, before I explain our rudimentary labs system, I want to invite you to our easter egg hunt. Check out <a href="http://art.sy/humans.txt">http://art.sy/humans.txt</a> for instructions.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2012/09/12/how-artsy-builds-experiments-labs-and-easter-eggs/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2012/08/16/testing-with-delayed-jobs/">
      <div class="date">




  
<time datetime="2012-08-16T21:21:00-04:00" pubdate>08/16/12</time></div>
    
    
      <h1 class="entry-title">Testing With Delayed Jobs</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p>A mean bug made it into our production environment. It wasn&#8217;t caught by our extensive test suite and caused thousands of emails to be sent to a handful of people. The root cause was an unfortunate combination of <a href="https://github.com/plataformatec/devise">Devise</a>, <a href="https://github.com/collectiveidea/delayed_job">DelayedJob</a> and, of course, our own code. It was an easy fix, but nobody ever wants this to happen again.</p>

<p>tl;dr DelayedJob says it&#8217;s possible to set <code>Delayed::Worker.delay_jobs = false</code> for your tests. Don&#8217;t do it.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2012/08/16/testing-with-delayed-jobs/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2012/08/14/on-objective-c-code-standards/">
      <div class="date">




  
<time datetime="2012-08-14T14:23:00-04:00" pubdate>08/14/12</time></div>
    
    
      <h1 class="entry-title">On Our Objective-C Code Standards</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p>With the release of Xcode 4.4 I&#8217;ve taken a look back at our existing code standards and tried to come up with something that is cleaner and more elegant. Here are a few of the ideas I&#8217;ve been using to modernize the codebase.</p>

<h3>Remove private method declarations and use class extensions to add ivars.</h3>

<p>First to get chopped by the deletion button are private method declarations. After Xcode 4.2 came out we took to using the class extension feature to add private method declarations at the top of implementation files. This was a nice way of keeping private methods out of the header files. Now that the compiler will check for pre-existing method signatures within the same object there&#8217;s no need to define their interfaces.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2012/08/14/on-objective-c-code-standards/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2012/07/10/on-demand-jenkins-slaves-with-amazon-ec2/">
      <div class="date">




  
<time datetime="2012-07-10T13:30:00-04:00" pubdate>07/10/12</time></div>
    
    
      <h1 class="entry-title">On-Demand Jenkins Slaves With Amazon EC2</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p>The <a href="http://art.sy">Art.sy</a> team faithfully uses <a href="http://jenkins-ci.org">Jenkins</a> for continuous integration. <a href="http://artsy.github.com/blog/2012/05/27/using-jenkins-for-ruby-and-ruby-on-rails-teams/">As we&#8217;ve described before</a>, our Jenkins master and 8 slaves run on Linode. This arrangement has at least a few drawbacks:</p>

<ul>
<li>Our Linode servers are manually configured. They require frequent maintenance, and inconsistencies lead to surprising build failures.</li>
<li>The fixed set of slaves don&#8217;t match the pattern of our build jobs: jobs get backed up during the day, but servers are mostly unused overnight and on weekends.</li>
</ul>


<p>The <a href="https://wiki.jenkins-ci.org/display/JENKINS/Amazon+EC2+Plugin">Amazon EC2 Plugin</a> allowed us to replace those slaves with a totally scripted environment. Now, slaves are spun up in the cloud whenever build jobs need them.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2012/07/10/on-demand-jenkins-slaves-with-amazon-ec2/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2012/07/05/spend-time-with-your-site/">
      <div class="date">




  
<time datetime="2012-07-05T10:51:00-04:00" pubdate>07/05/12</time></div>
    
    
      <h1 class="entry-title">Spend Time With Your Site</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p>Empathy with end users is critical when developing consumer-facing software. Many go <a href="http://innonate.com/2011/03/09/hackers-the-canon-of-consumer-facing-products/">even</a> <a href="http://www.uie.com/articles/self_design/">further</a> and argue that you should <em>be</em> your own user to effectively deliver the best experience.</p>

<blockquote><p><em>I&#8217;d encourage anyone starting a startup to become one of its users, however unnatural it seems.</em></p>

<p>&mdash; Paul Graham <a href="http://paulgraham.com/organic.html">Organic Startup Ideas</a></p></blockquote>

<p>In practice, though, this can be difficult:</p>

<ul>
<li>As a developer, you&#8217;re just not representative of the intended audience.</li>
<li>You&#8217;re [appropriately] focused on the product&#8217;s next iteration, while your audience is occupied with the current state.</li>
<li>You spend countless hours focused on product details&mdash;of course it&#8217;s a challenge to empathize with a casual visitor&#8217;s first impression.</li>
</ul>


<h2>Keeping it Real</h2>

<p>We&#8217;ve tried some best practices to overcome these tendencies. User feedback is emailed to everyone in the company. Engineers share customer support responsibilities. But one simple tool has been surprisingly useful: we stole a page from the agile development handbook and built an <a href="http://alistair.cockburn.us/Information+radiator">information radiator</a>. Like a <a href="http://en.wikipedia.org/wiki/Kanban_board">kanban board</a>, news ticker, or <a href="https://demo.geckoboard.com/dashboard/B6782E562794C2F2/">analytics wall board</a>, our information radiator gives us an ambient awareness of end users&#8217; experiences. How?</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2012/07/05/spend-time-with-your-site/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
    </div>
    <div id="sidebar">
      
  
    <section>
  <h1>Info</h1>
  <ul>
    <li> <a href="/about">About Us</a></li>
    <li> <a href="/open-source">Art.sy Open-Source</a></li>
    <li> <a href="http://art.sy/job/developer">Join the Art.sy Engineering Team</a></li>
  </ul>
</section>
<section id="recent_posts_section">
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/10/18/the-perils-of-ios-user-agent-sniffing/">The perils of iOS user agent strings</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/18/so-you-want-to-do-a-css3-3d-transform/">So you want to do a CSS3 3D transform?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/10/artsy-technology-stack/">Art.sy's Technology Stack</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/09/how-to-run-rspec-test-suites-in-parallel-with-jenkins-ci-build-flow/">How to Run RSpec Test Suites in Parallel with JenkinsCI Build Flow</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/13/on-grid-thumbnails/">On Grid Thumbnails</a>
      </li>
    
  </ul>
  <a class="archive_link" href="/blog/archives">Blog Archive</a>
</section>
<section>
  <h1>Search</h1>
  <form action="http://google.com/search" method="get">
    <input type="hidden" name="q" value="site:artsy.github.com" />
    <input class="search" type="text" name="q" results="0" />
  </form>
</section>
  


    </div>
  </div>
  <footer id="main_footer"><p>
  Copyright &copy; 2012 - Art.sy -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'artsy';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
